"use client";

import { useState } from "react";

interface Worker {
    id: string;
    staffId: string;
    fullName: string | null;
    firstName: string | null;
    lastName: string | null;
    gradeLevel: string | null;
    step: string | null;
    designation: string | null;
    isFlagged: boolean;
    flagReason: string | null;
    department: string | null;
    ministry: string | null;
}

export default function ExportFlaggedWorkers({ workers, stateName }: { workers: Worker[], stateName: string }) {
    const [isExporting, setIsExporting] = useState(false);

    const handleExport = () => {
        setIsExporting(true);
        try {
            // 1. Filter for flagged workers
            const flaggedWorkers = workers.filter(w => w.isFlagged);

            if (flaggedWorkers.length === 0) {
                alert("No flagged workers found to export.");
                setIsExporting(false);
                return;
            }

            // 2. Define CSV Headers
            const headers = [
                "Staff ID",
                "Full Name",
                "Designation",
                "Department",
                "Ministry",
                "Grade Level",
                "Step",
                "Flag Reason"
            ];

            // 3. Convert data to CSV rows
            const csvContent = [
                headers.join(","), // Header row
                ...flaggedWorkers.map(w => {
                    const name = w.fullName || `${w.firstName || ''} ${w.lastName || ''}`.trim();
                    // Escape quotes and handle commas in content
                    const escaped = (field: string | null) => {
                        if (!field) return "";
                        return `"${field.replace(/"/g, '""')}"`; // Double up quotes to escape them
                    };

                    return [
                        escaped(w.staffId),
                        escaped(name),
                        escaped(w.designation),
                        escaped(w.department),
                        escaped(w.ministry),
                        escaped(w.gradeLevel),
                        escaped(w.step),
                        escaped(w.flagReason)
                    ].join(",");
                })
            ].join("\n");

            // 4. Create Blob and Trigger Download
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");

            const timestamp = new Date().toISOString().split('T')[0];
            link.setAttribute("href", url);
            link.setAttribute("download", `${stateName}_Flagged_Workers_${timestamp}.csv`);
            link.style.visibility = "hidden";

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

        } catch (error) {
            console.error("Export failed:", error);
            alert("Failed to export data.");
        } finally {
            setIsExporting(false);
        }
    };

    return (
        <button
            onClick={handleExport}
            disabled={isExporting}
            className="flex items-center gap-2 rounded-xl border-2 border-red-100 bg-red-50 px-6 py-3 text-sm font-bold text-red-600 transition-all hover:bg-red-100 dark:border-red-900/30 dark:bg-red-900/20 dark:text-red-400 dark:hover:bg-red-900/40"
        >
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="7 10 12 15 17 10" />
                <line x1="12" y1="15" x2="12" y2="3" />
            </svg>
            {isExporting ? "Exporting..." : "Export Flagged Issues"}
        </button>
    );
}
