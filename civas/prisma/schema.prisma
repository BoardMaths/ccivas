generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// AUTHENTICATION & USER MANAGEMENT
// ============================================================================

model User {
  id            String    @id @default(cuid())
  kindeId       String?   @unique
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  firstName     String?
  lastName      String?
  role          Role      @default(USER)
  accounts      Account[]
  sessions      Session[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String? @db.Text
  access_token       String? @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? @db.Text
  session_state      String?
 
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
 
  @@unique([provider, providerAccountId])
}
 
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
 
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
 
  @@unique([identifier, token])
}

// ============================================================================
// ENUMS
// ============================================================================

enum Role {
  SUPERADMIN
  ADMIN
  USER
}

enum DocumentType {
  BIRTH_CERTIFICATE_AGE_DECLARATION
  NOTIFICATION_OF_APPOINTMENT
  CONVERSION_TO_PERMANENT_APPOINTMENT
  CONFIRMATION_OF_APPOINTMENT
  NOTIFICATION_OF_PROMOTION
  FIRST_SCHOOL_LEAVING_CERTIFICATE
  SCHOOL_CERTIFICATE
  NIN_SLIP
  NYSC_DISCHARGE_CERTIFICATE
  NYSC_EXEMPTION_CERTIFICATE
  NYSC_EXCLUSION_LETTER
  OTHER
}

enum NYSCStatus {
  DISCHARGED
  EXEMPTED
  EXCLUDED
  NONE
}

enum AppointmentType {
  PERMANENT_PENSIONABLE
  PROBATION
  CONTRACT
  TEMPORARY
  SECONDMENT
  ACTING
}

enum CareerActionType {
  PROMOTION
  CONVERSION
  ADVANCEMENT
  CONFIRMATION
  TRANSFER
  SECONDMENT
  ACTING_APPOINTMENT
  REDEPLOYMENT
  DEMOTION
}

enum LeaveType {
  ANNUAL
  SICK
  MATERNITY
  PATERNITY
  STUDY_WITH_PAY
  STUDY_WITHOUT_PAY
  CASUAL
  COMPASSIONATE
  SABBATICAL
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

// ============================================================================
// STATE & ORGANIZATIONAL STRUCTURE
// ============================================================================

model State {
  id                  String                @id @default(cuid())
  name                String                @unique
  code                String                @unique
  
  workers             Worker[]
  activities          Activity[]
  cadres              Cadre[]
  salaryStructures    SalaryStructure[]
  retirementRules     StateRetirementRule[]

  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt

  @@index([name])
  @@index([code])
}

// ============================================================================
// CADRE SYSTEM
// ============================================================================

model Cadre {
  id                  String                @id @default(cuid())
  name                String                // e.g., "Administrative", "Teaching", "Medical"
  code                String                // e.g., "ADM", "TCH", "MED"
  description         String?
  
  minGradeLevel       String                // Minimum GL for this cadre
  maxGradeLevel       String                // Maximum GL this cadre can reach
  
  // Promotion intervals (stored as JSON)
  // Example: {"03-06": 2, "07-14": 3, "15-17": 4}
  promotionIntervals  Json?
  
  // Cadre-specific rules
  requiresNYSC        Boolean               @default(true)
  requiresProfessionalCert Boolean          @default(false)
  
  // Mapping of Qualifications to entry levels/designations
  // Example: {"BSC": {"gl": "08", "designation": "Admin Officer II"}}
  entryRequirements   Json?
  
  stateId             String
  state               State                 @relation(fields: [stateId], references: [id], onDelete: Cascade)
  
  workers             Worker[]
  salaryStructures    SalaryStructure[]
  retirementRules     StateRetirementRule[]
  
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  
  @@unique([stateId, code])
  @@index([stateId])
}

// ============================================================================
// SALARY MANAGEMENT
// ============================================================================

model SalaryStructure {
  id                  String        @id @default(cuid())
  name                String        // e.g., "Ebonyi State Teaching Staff 2024"
  description         String?
  
  effectiveDate       DateTime      // When this structure became active
  endDate             DateTime?     // When it was replaced (null if current)
  
  stateId             String
  state               State         @relation(fields: [stateId], references: [id], onDelete: Cascade)
  
  cadreId             String?       // Null means applies to all cadres
  cadre               Cadre?        @relation(fields: [cadreId], references: [id])
  
  salaryGrades        SalaryGrade[]
  
  isActive            Boolean       @default(true)
  isDefault           Boolean       @default(false)

  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  
  @@index([stateId, cadreId, effectiveDate])
  @@index([effectiveDate])
}

model SalaryGrade {
  id                      String          @id @default(cuid())
  
  structureId             String
  structure               SalaryStructure @relation(fields: [structureId], references: [id], onDelete: Cascade)
  
  gradeLevel              String          // e.g., "08"
  step                    String          // e.g., "01"
  postTitle               String?         // Optional post/position
  
  // Salary Components
  basicSalary             Decimal         @db.Decimal(12, 2)
  housingAllowance        Decimal?        @db.Decimal(12, 2)
  transportAllowance      Decimal?        @db.Decimal(12, 2)
  utilityAllowance        Decimal?        @db.Decimal(12, 2)
  mealAllowance           Decimal?        @db.Decimal(12, 2)
  domesticStaffAllowance  Decimal?        @db.Decimal(12, 2) // For senior staff (gardener, cook, etc.)
  furnitureAllowance      Decimal?        @db.Decimal(12, 2)
  entertainmentAllowance  Decimal?        @db.Decimal(12, 2)
  rentAllowance           Decimal?        @db.Decimal(12, 2)
  leaveAllowance          Decimal?        @db.Decimal(12, 2)
  otherAllowances         Json?           // For flexible allowances
  
  grossSalary             Decimal         @db.Decimal(12, 2) // Total before deductions
  
  // Tax and Deductions (as percentages)
  taxRate                 Decimal?        @db.Decimal(5, 2) // Percentage
  pensionRate             Decimal?        @db.Decimal(5, 2) // Percentage (usually 8%)
  nhfRate                 Decimal?        @db.Decimal(5, 2) // National Housing Fund (usually 2.5%)
  
  netSalary               Decimal         @db.Decimal(12, 2) // After deductions
  
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  
  @@unique([structureId, gradeLevel, step, postTitle])
  @@index([structureId])
  @@index([gradeLevel, step])
}

// ============================================================================
// WORKER MANAGEMENT
// ============================================================================

model Worker {
  id                      String              @id @default(cuid())
  staffId                 String              @unique
  firstName               String
  lastName                String
  middleName              String?
  fullName                String?
  imageUrl                String?
  email                   String?
  phone                   String?
  
  // Personal Info
  dob                     DateTime?
  gender                  String?
  maritalStatus           String?
  placeOfBirth            String?
  stateOfOrigin           String?
  lgaOfOrigin             String?
  
  // Identity & Administrative
  nin                     String?
  fileNumber              String?             // Personnel file reference
  ippisNumber             String?             // Integrated Personnel and Payroll ID
  
  // Financial & Banking
  bvn                     String?
  accountNumber           String?
  bankName                String?
  pfaName                 String?             // Pension Fund Administrator
  rsaNumber               String?             // Retirement Savings Account
  
  // Medical
  bloodGroup              String?
  genotype                String?

  // Next of Kin
  nextOfKinName           String?
  nextOfKinPhone          String?
  nextOfKinRelationship   String?
  
  // Address
  residentialAddress      String?

  // Cadre and Appointment Type
  cadreId                 String?
  cadre                   Cadre?              @relation(fields: [cadreId], references: [id])
  
  appointmentType         AppointmentType     @default(TEMPORARY)
  isConfirmed             Boolean             @default(false)
  
  // Employment Dates
  appointmentDate         DateTime?
  dateOfFirstAppointment  DateTime?
  entryGradeLevel         String?
  entryStep               String?
  dateOfPresentAppointment DateTime?
  dateOfConfirmation      DateTime?
  confirmationGradeLevel  String?
  confirmationStep        String?
  confirmationLetterRef   String?
  
  // Current Position
  rank                    String?
  gradeLevel              String?
  step                    String?
  designation             String?
  postTitle               String?             // Official post title
  postCode                String?             // Post code in establishment
  
  // Salary (Current)
  salaryScale             String?
  salaryAmount            String?             // Legacy field
  currentSalaryStructureId String?
  basicSalary             Decimal?            @db.Decimal(12, 2)
  housingAllowance        Decimal?            @db.Decimal(12, 2)
  transportAllowance      Decimal?            @db.Decimal(12, 2)
  otherAllowances         Json?
  grossSalary             Decimal?            @db.Decimal(12, 2)
  netSalary               Decimal?            @db.Decimal(12, 2)
  
  // Organization
  ministry                String?
  department              String?
  
  // Permissions (based on confirmation status)
  canApplyLeave           Boolean             @default(false)
  canApplyNYSC            Boolean             @default(false)
  canApplyTraining        Boolean             @default(false)
  
  // Flagging
  isFlagged               Boolean             @default(false)
  flagReason              String?
  flagSeverity            String?             // LOW, MEDIUM, HIGH, CRITICAL

  isSuspended             Boolean             @default(false)
  suspensionDate          DateTime?
  suspensionReason        String?

  lastStepIncrementDate   DateTime?

  // Education & NYSC
  highestQualification    String?
  nyscStatus              NYSCStatus          @default(NONE)
  nyscYear                String?
  nyscState               String?
  nyscNumber              String?

  // Relations
  stateId                 String
  state                   State               @relation(fields: [stateId], references: [id], onDelete: Cascade)
  
  documents               Document[]
  promotions              Promotion[]         // Legacy - will be migrated to CareerAction
  certificates            AcademicCertificate[]
  careerActions           CareerAction[]
  leaveRecords            LeaveRecord[]
  
  isVerified              Boolean             @default(false)
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt

  @@index([stateId])
  @@index([cadreId])
  @@index([staffId])
  @@index([isFlagged])
}

// ============================================================================
// CAREER ACTIONS (Replaces and extends Promotion)
// ============================================================================

model CareerAction {
  id                  String            @id @default(cuid())
  workerId            String
  worker              Worker            @relation(fields: [workerId], references: [id], onDelete: Cascade)
  
  type                CareerActionType
  effectiveDate       DateTime
  
  // From (previous position)
  fromGradeLevel      String?
  fromStep            String?
  fromDesignation     String?
  fromSalary          Decimal?          @db.Decimal(12, 2)
  
  // To (new position)
  toGradeLevel        String
  toStep              String
  toDesignation       String?
  toSalary            Decimal?          @db.Decimal(12, 2)
  
  // Documentation (Required for PROMOTION)
  authorityReference  String?           // e.g., "MOF/EST/2024/0456"
  gazetteNumber       String?           // Official gazette publication number
  approvalDate        DateTime?
  approvedBy          String?           // Approving authority
  
  // Additional info
  reason              String?
  remarks             String?
  documentUrl         String?           // Link to official document
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  
  @@index([workerId, type])
  @@index([effectiveDate])
  @@index([type])
}

// ============================================================================
// LEGACY MODELS (Kept for backward compatibility)
// ============================================================================

model Promotion {
  id              String   @id @default(cuid())
  workerId        String
  worker          Worker   @relation(fields: [workerId], references: [id], onDelete: Cascade)
  date            DateTime
  gradeLevel      String
  step            String?
  designation     String?
  salary          String?
  
  // NEW: Documentation fields
  authorityReference String?
  gazetteNumber      String?
  
  createdAt       DateTime @default(now())

  @@index([workerId])
}

model AcademicCertificate {
  id                String   @id @default(cuid())
  workerId          String
  worker            Worker   @relation(fields: [workerId], references: [id], onDelete: Cascade)
  type              String
  institution       String
  year              String
  certificateNumber String?
  createdAt         DateTime @default(now())

  @@index([workerId])
}

model Document {
  id            String       @id @default(cuid())
  workerId      String
  worker        Worker       @relation(fields: [workerId], references: [id], onDelete: Cascade)
  type          DocumentType
  url           String
  name          String?
  
  // AI Extraction results
  extractedName String?
  extractedDate DateTime?
  confidence    Float?
  warnings      Json?
  extractedData Json?
  
  isVerified    Boolean      @default(false)

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([workerId])
}

// ============================================================================
// STATE-SPECIFIC RULES
// ============================================================================

model StateRetirementRule {
  id                  String    @id @default(cuid())
  
  stateId             String
  state               State     @relation(fields: [stateId], references: [id], onDelete: Cascade)
  
  cadreId             String?   // Null means applies to all cadres
  cadre               Cadre?    @relation(fields: [cadreId], references: [id])
  
  retirementAge       Int       // e.g., 60, 65 for teachers in Ebonyi
  maxServiceYears     Int       // e.g., 35
  
  effectiveDate       DateTime
  endDate             DateTime?
  
  remarks             String?
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  @@unique([stateId, cadreId, effectiveDate])
  @@index([stateId])
}

// ============================================================================
// LEAVE MANAGEMENT
// ============================================================================

model LeaveRecord {
  id                  String      @id @default(cuid())
  workerId            String
  worker              Worker      @relation(fields: [workerId], references: [id], onDelete: Cascade)
  
  leaveType           LeaveType
  startDate           DateTime
  endDate             DateTime
  numberOfDays        Int
  
  status              LeaveStatus @default(PENDING)
  appliedDate         DateTime    @default(now())
  approvedDate        DateTime?
  approvedBy          String?
  
  reason              String?
  remarks             String?
  
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  
  @@index([workerId])
  @@index([status])
}

// ============================================================================
// ACTIVITY LOG
// ============================================================================

model Activity {
  id        String   @id @default(cuid())
  title     String
  type      String
  stateId   String
  state     State    @relation(fields: [stateId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([stateId])
}
